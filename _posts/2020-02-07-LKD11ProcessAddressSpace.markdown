---
layout:     post
title:      "LKD Process Address Space"
subtitle:   "进程地址空间"
date:       2020-02-07 13:46:00
author:     "zhouhd"
header-img: "img/about-bg.jpg"
catalog: true
tags:
    - Linux
    - Linux Kernel
---

对应LKD3第15章进程地址空间。

- 进程内存区域一般包括：代码段、数据段、BSS段、进程用户空间栈、动态链接库的代码段/数据段/BSS段、内存映射文件、共享内存段、匿名内存映射、堆。
- 内核使用mm_struct内存描述符结构体表示进程的地址空间，创建新进程时一般会从slab分配新的mm_struct，如果调用clone()时设置了CLONE_VM，表明新进程和父进程共享内存空间，也就是一个线程。
- 内核线程没有进程地址空间，也没有相关内存描述符。在进程调度时，内核线程会使用前一个进程的页表，不过内核线程不访问用户空间里的内存，仅使用和内核相关信息。
- 内存区域由vm_area_struct结构体描述，描述了指定地址空间内连续区间上的一个独立内存范围。每个内存区域有统一的访问权限和操作方式等等。
- 内存区域在内存描述符里面有两个字段，一个是链表，一个是红黑树，红黑树的根据地址来排列，用于查找某个地址在哪个内存区域或者类似操作。
- 内核使用do_mmap()创建一个新的线性地址空间，如果这个空间和已有空间相邻，会被合并到已有内存空间。
- 每个进程都有自己的页表（线程共享），用于将虚拟内存映射为物理内存。为了加快地址转换速度，多数体系都有TLB硬件缓存用于缓存已映射的地址。