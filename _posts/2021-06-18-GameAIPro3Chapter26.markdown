---
layout:     post
title:      "Guide to Effective Auto-Generated Spatial Queries"
subtitle:   "GameAIPro3 Chapter26"
date:       2021-06-18  18:19:00
author:     "zhouhd"
header-img: "img/about-bg.jpg"
catalog: true
tags:
    - GameAI
    - GameAIPro
    - GameAIPro3
    - GameProgramming
---

## 概览
- 寻找掩体等行为，依赖空间查询，一个用于给角色指定行为寻找目标点的系统
- 使用预生成位置的静态方案，不能用在动态可破坏可变化场景。
- 动态生成方案做成一个通用系统，可以让其它功能和系统使用
- UE4的Environment Query System是具体的一个例子

## 空间查询概念
- 采样点：候选位置，后续将进行评分，估计它们作为目标点的合适程度
- 生成器：生成采样点的方法，例如生成半径10米的环
- 生成原点：执行生成器的位置，一般是角色自身位置，或者角色的交互目标的位置
- 测试：对采样点进行打分或者筛选，例如距离越远分数越低，或者不可见就直接剔除
- 参照对象：测试涉及的位置或者目标，例如采样点附近的几个敌人
- 例如要包围一个敌人，应该以敌人位置为原点，采用环形生成器。采样点能直接看见敌人，并且要和队友保持一定距离

## 生成采样点
- 预生成位置的静态方案，直接选取一定范围内的点作为采样点即可
- 动态方案一般在导航网格上进行，可以基本保证位置可以到达，寻找采样点之前需要先寻找合适的导航网格多边形
- 常用选择多边形的方案有两种，包围盒和距离，也可以结合两种方案，或者自行设计
- 包围盒方案，以目标点为中心，选择范围内的多边形网格，可能选择到一些和目标点不相连的多边形，适合远程攻击位置选择
- 距离方案，以目标为中心，选择一定移动距离以内的多边形，保证和目标点相连，适合跟随和包围
- 采样点生成可以采用一对多方式，对于同一水平坐标，有多个不同高度的点
- 最常用生成结构是均匀分布的格子、环形、六边形、直线等等，只用格子会导致候选点过于规范，而且需要排除大量不符合规则的点

## 测试
- 多目标情况下，距离测试有多种选择。平均距离，计算给定位置离所有目标的距离平均值，质心位置的计算值最小，例如用于指挥官保持在队伍中心保证安全和通信便利。最小距离，计算离所有目标的距离的最小值，可用于跟随或者远离队友
- 点积测试，用于角度相关的情况，例如跟随在敌人身后，或者保持在队友右边，或者保持在镜头前面
- 用sin函数进一步处理点积结果，可以实现侧面进攻
- 对于玩家可以飞行、跳跃或者爬墙的情况，一般需要采用玩家地板位置或者最近位置作为生成原点，因为可能不在导航网格上面
- 对于测试评分，还可以使用平方、平方根、sin等等函数进一步处理

## 其它实现细节
- 一般的空间查询可以放在确定行为后，根据行为需求计算移动目标点，再移动过去，并且需要定期更新或者重算
- 还有一种架构，将更新和实际移动分离，两部分计算独立并行，可以更好控制更新频率
- 注意做好容错和保底方案
